name: Deploy Frontend

"on":
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH deploy frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            cd /var/www/myalmet/frontend-src
            git pull origin main

            docker build --no-cache -t myalmet-frontend:latest .

            docker stop frontend || true
            docker rm frontend || true

            docker run -d --name frontend \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e PORT=3000 \
              -e HOSTNAME=0.0.0.0 \
              -e NEXT_PUBLIC_API_URL=https://www.myalmet.com \
              myalmet-frontend:latest \
              sh -lc 'mkdir -p .next/standalone/.next && rm -rf .next/standalone/.next/static && cp -r .next/static .next/standalone/.next/static && node .next/standalone/server.js'

            curl -I --max-time 10 http://127.0.0.1:3000/ | head -n 1 || true
