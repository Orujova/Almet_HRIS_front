name: Deploy Frontend
"on":
  push:
    branches:
      - master
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH deploy frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            
            echo "=== Pulling latest code ==="
            cd /var/www/myalmet/frontend
            git pull origin master
            
            echo "=== Building Docker image ==="
            docker build --no-cache -t myalmet-frontend:latest .
            
            echo "=== Stopping old container ==="
            docker stop frontend || true
            docker rm frontend || true
            
            echo "=== Starting new container ==="
            docker run -d --name frontend \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e PORT=3000 \
              -e HOSTNAME=0.0.0.0 \
              -e NEXT_PUBLIC_API_URL=https://www.myalmet.com \
              myalmet-frontend:latest \
              sh -lc 'mkdir -p .next/standalone/.next && rm -rf .next/standalone/.next/static && cp -r .next/static .next/standalone/.next/static && node .next/standalone/server.js'
            
            echo "=== Waiting for container to start ==="
            sleep 5
            
            echo "=== Health check ==="
            curl -I --max-time 10 http://127.0.0.1:3000/ | head -n 1 || echo "Health check failed"
            
            echo "=== Cleaning old images ==="
            docker image prune -f
            
            echo "=== Deployment completed ==="
