name: Deploy MyAlmet (Backend + Frontend)

on:
  push:
    branches: ["main"]

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    steps:
      - name: SSH deploy backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            echo "== Backend: pull =="
            cd /var/www/myalmet/backend
            git pull origin main

            echo "== Backend: venv + deps =="
            source /var/www/myalmet/backend/venv/bin/activate
            pip install -r requirements.txt

            echo "== Backend: migrate + collectstatic =="
            python manage.py migrate --noinput
            python manage.py collectstatic --noinput

            echo "== Backend: restart gunicorn =="
            sudo systemctl restart gunicorn
            sudo systemctl is-active gunicorn

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: SSH deploy frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            echo "== Frontend: pull =="
            cd /var/www/myalmet/frontend-src
            git pull origin main

            echo "== Frontend: build image =="
            docker build --no-cache -t myalmet-frontend:latest .

            echo "== Frontend: replace container =="
            docker stop frontend || true
            docker rm frontend || true

            docker run -d --name frontend \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e PORT=3000 \
              -e HOSTNAME=0.0.0.0 \
              -e NEXT_PUBLIC_API_URL=https://www.myalmet.com \
              myalmet-frontend:latest \
              sh -lc 'mkdir -p .next/standalone/.next && rm -rf .next/standalone/.next/static && cp -r .next/static .next/standalone/.next/static && node .next/standalone/server.js'

            echo "== Frontend: quick checks =="
            curl -I --max-time 10 http://127.0.0.1:3000/ | head -n 1 || true
            curl -I --max-time 10 https://www.myalmet.com | head -n 1 || true

